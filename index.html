<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistente Digitale - Studio Demo</title>
  <meta name="description" content="Assistente digitale per Studio Dentistico Demo - Informazioni, orari, contatti e prenotazioni online">
  <meta name="keywords" content="dentista, studio dentistico, assistente digitale, prenotazioni online">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://assistente-digitale-studio-dentistico.onrender.com">
  <meta property="og:title" content="Assistente Digitale - Studio Demo">
  <meta property="og:description" content="Demo dell'assistente digitale per studi dentistici con ChatGPT">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://assistente-digitale-studio-dentistico.onrender.com">
  
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/logo.png">
</head>
<body>
  <!-- ==================== OVERLAY BACKGROUND ==================== -->
  <div id="overlay-bg"></div>

  <!-- ==================== MAIN CONTENT ==================== -->
  <div class="main-content">
    
    <!-- ==================== SIDEBAR ==================== -->
    <div class="sidebar">
      
      <!-- Branding Section -->
      <div class="branding">
        <img src="images/logo.png" alt="Logo Studio" class="logo">
        <div class="studio-name" id="studio-name">Studio Dentistico Demo</div>
        <div class="studio-site" id="studio-site">www.studiodemo.it</div>
        <div class="photos">
          <img src="images/1.jpg" alt="Foto Studio 1" onclick="openPopup('popup-gallery')" loading="lazy">
          <img src="images/2.jpg" alt="Foto Studio 2" onclick="openPopup('popup-gallery')" loading="lazy">
          <img src="images/3.jpg" alt="Foto Studio 3" onclick="openPopup('popup-gallery')" loading="lazy">
          <div class="more" onclick="openPopup('popup-gallery')" title="Visualizza tutte le foto">
            <i class="fas fa-images"></i>
          </div>
        </div>
      </div>

      <!-- Promo Section -->
      <div class="promo" id="promo-section">
        <h4>üéÅ Offerta Speciale: Igiene Orale</h4>
        <p class="scadenza">Valida fino al <strong>31 Luglio 2025</strong></p>
        <p class="descrizione">Prenota ora una pulizia completa e ricevi il <strong>20% di sconto</strong> sulla prossima visita!</p>
      </div>

      <!-- Info Buttons -->
      <div class="info-buttons">
        <button class="chat-assistant-btn" onclick="openMobileChat()" aria-label="Chatta con l'Assistente Digitale">
          <img src="https://assistente-digitale.it/images/favicon.png" alt="Assistente Digitale" class="assistant-icon">
          Chiedi al nostro Assistente Digitale
        </button>
        <button onclick="openPopup('popup-info-studio')" aria-label="Informazioni sullo Studio">
          <i class="fas fa-info-circle"></i> Informazioni sullo Studio
        </button>
        <button onclick="openPopup('popup-specializzazioni')" aria-label="Specializzazioni odontoiatriche">
          <i class="fas fa-tooth"></i> Specializzazioni odontoiatriche
        </button>
        <button onclick="openPopup('popup-orari')" aria-label="Orari dello studio">
          <i class="fas fa-clock"></i> Orari dello studio
        </button>
        <button onclick="openPopup('popup-supporto')" aria-label="Assistenza e contatti">
          <i class="fas fa-headset"></i> Assistenza e contatti
        </button>
        <button onclick="openPopup('popup-location')" aria-label="Dove trovarci">
          <i class="fas fa-map-marker-alt"></i> Dove trovarci
        </button>
      </div>
    </div>

    <!-- ==================== CHAT WINDOW (DESKTOP) ==================== -->
    <div class="chat-window">
      <div class="chat-header">
        <img src="images/logo.png" alt="Logo Studio">
        <span id="chat-title">Assistente Digitale - Studio Demo</span>
      </div>
      <div class="chat-body" id="chat-body">
        <!-- Messaggi chat caricati dinamicamente -->
      </div>
      <div class="chat-input">
        <input type="text" 
               id="user-input" 
               placeholder="Scrivi qui la tua domanda..." 
               maxlength="500"
               autocomplete="off"
               onkeypress="handleEnterKey(event)">
        <button onclick="sendMessage()" 
                id="send-button"
                aria-label="Invia messaggio"
                title="Invia messaggio">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MOBILE CHAT WIDGET ==================== -->
  <div class="chat-widget">
    <button class="chat-widget-button" onclick="openMobileChat()" aria-label="Apri chat assistente">
      <img src="https://assistente-digitale.it/images/favicon.png" alt="Chat Assistant">
      <div class="chat-notification" id="chat-notification">1</div>
    </button>
  </div>

  <!-- Chat Overlay Mobile -->
  <div class="chat-overlay" id="chat-overlay" onclick="closeMobileChat()"></div>

  <!-- Chat Mobile Fullscreen -->
  <div class="chat-mobile" id="chat-mobile">
    <div class="chat-mobile-header">
      <div class="chat-mobile-title">
        <img src="https://assistente-digitale.it/images/favicon.png" alt="Logo Studio">
        <span>Assistente Digitale</span>
      </div>
      <button class="chat-close-btn" onclick="closeMobileChat()" aria-label="Chiudi chat">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="chat-mobile-body" id="chat-mobile-body">
      <!-- Messaggi chat mobile -->
    </div>
    <div class="chat-mobile-input">
      <input type="text" 
             id="mobile-user-input" 
             placeholder="Scrivi qui la tua domanda..." 
             maxlength="500"
             autocomplete="off"
             onkeypress="handleMobileEnterKey(event)">
      <button onclick="sendMobileMessage()" 
              id="mobile-send-button"
              aria-label="Invia messaggio">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- ==================== POPUP: INFORMAZIONI STUDIO ==================== -->
  <div id="popup-info-studio" class="info-popup" role="dialog" aria-labelledby="popup-studio-title" aria-modal="true">
    <h3 id="popup-studio-title">
      <img src="images/logo.png" alt="Logo Studio" style="width: 28px; height: 28px; border-radius: 50%; vertical-align: middle; margin-right: 10px;">
      Studio Dentistico Demo
    </h3>

    <div class="info-studio-grid" id="info-studio-content">
      <!-- Contenuto caricato dinamicamente da ui-manager.js -->
    </div>

    <button class="close-btn" onclick="closePopup('popup-info-studio')" aria-label="Chiudi popup">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== POPUP: SPECIALIZZAZIONI ==================== -->
  <div id="popup-specializzazioni" class="info-popup" role="dialog" aria-labelledby="specializzazioni-title" aria-modal="true">
    <h3 id="specializzazioni-title">
      <i class="fas fa-tooth"></i> Le nostre Specializzazioni
    </h3>
    <div class="specialties-grid" id="specialties-content">
      <!-- Contenuto caricato dinamicamente da ui-manager.js -->
    </div>
    <button class="close-btn" onclick="closePopup('popup-specializzazioni')" aria-label="Chiudi popup">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== POPUP: ORARI ==================== -->
  <div id="popup-orari" class="info-popup" role="dialog" aria-labelledby="orari-title" aria-modal="true">
    <h3 id="orari-title">
      <i class="fas fa-clock"></i> Orari di Apertura
    </h3>
    <div class="schedule-grid" id="schedule-content">
      <!-- Contenuto caricato dinamicamente da ui-manager.js -->
    </div>
    <button class="close-btn" onclick="closePopup('popup-orari')" aria-label="Chiudi popup">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== POPUP: SUPPORTO ==================== -->
  <div id="popup-supporto" class="info-popup" role="dialog" aria-labelledby="supporto-title" aria-modal="true">
    <h3 id="supporto-title">
      <i class="fas fa-headset"></i> Contattaci
    </h3>
    <div class="support-grid" id="support-content">
      <!-- Contenuto caricato dinamicamente da ui-manager.js -->
    </div>
    <button class="close-btn" onclick="closePopup('popup-supporto')" aria-label="Chiudi popup">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== POPUP: LOCATION ==================== -->
  <div id="popup-location" class="info-popup" role="dialog" aria-labelledby="location-title" aria-modal="true">
    <h3 id="location-title">
      <i class="fas fa-map-marker-alt"></i> Dove Siamo
    </h3>
    <div id="location-content">
      <!-- Contenuto caricato dinamicamente da ui-manager.js -->
    </div>
    <button class="close-btn" onclick="closePopup('popup-location')" aria-label="Chiudi popup">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== POPUP: GALLERY ==================== -->
  <div id="popup-gallery" class="info-popup gallery-popup" role="dialog" aria-labelledby="gallery-title" aria-modal="true">
    <h3 id="gallery-title">
      <i class="fas fa-images"></i> Studio Dentistico Demo
    </h3>

    <!-- Immagine principale -->
    <div class="gallery-main">
      <img id="main-gallery-img" src="images/1.jpg" alt="Foto studio principale" loading="lazy">
    </div>

    <!-- Miniature orizzontali -->
    <div class="gallery-thumbnails">
      <img src="images/1.jpg" 
           alt="Foto studio 1" 
           onclick="updateMainGallery(this)" 
           onkeypress="handleImageKeyPress(event, this)"
           tabindex="0"
           loading="lazy">
      <img src="images/2.jpg" 
           alt="Foto studio 2" 
           onclick="updateMainGallery(this)"
           onkeypress="handleImageKeyPress(event, this)"
           tabindex="0"
           loading="lazy">
      <img src="images/3.jpg" 
           alt="Foto studio 3" 
           onclick="updateMainGallery(this)"
           onkeypress="handleImageKeyPress(event, this)"
           tabindex="0"
           loading="lazy">
    </div>

    <button class="close-btn" onclick="closePopup('popup-gallery')" aria-label="Chiudi gallery">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- ==================== FOOTER ==================== -->
  <footer class="footer-info">
    <div class="footer-left">
      <img src="images/logo.png" alt="Logo Studio" loading="lazy">
      <div class="social-icons">
        <a href="#" title="Facebook" aria-label="Seguici su Facebook" target="_blank" rel="noopener">
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="#" title="Instagram" aria-label="Seguici su Instagram" target="_blank" rel="noopener">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="#" title="WhatsApp" aria-label="Contattaci su WhatsApp" target="_blank" rel="noopener">
          <i class="fab fa-whatsapp"></i>
        </a>
        <a href="#" title="YouTube" aria-label="Iscriviti al nostro canale YouTube" target="_blank" rel="noopener">
          <i class="fab fa-youtube"></i>
        </a>
        <a href="#" title="LinkedIn" aria-label="Collegati con noi su LinkedIn" target="_blank" rel="noopener">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </div>
    </div>

    <div class="footer-center" id="footer-info">
      Studio Dentistico Demo SRL<br>
      P.IVA 01234567890<br>
      Iscrizione Albo Medici Odontoiatri: MI-123456
    </div>

    <div class="footer-right">
      <img src="https://assistente-digitale.it/images/logo-verticale.png" 
           alt="Digital&More Logo" 
           style="height: 50px; margin-bottom: 8px;"
           loading="lazy">
      <p>L'Assistente Digitale √® un servizio fornito da 
        <a href="https://digitalandmore.it" target="_blank" rel="noopener">digitalandmore.it</a>
      </p>
    </div>
  </footer>

    <!-- ==================== JAVASCRIPT ==================== -->
  <script>
    // ==================== GLOBAL VARIABLES ====================
    let mobileChat = {
      isOpen: false,
      hasNewMessage: false,
      isInitialized: false
    };

    let chatSyncEnabled = true;

    // ==================== MOBILE CHAT WIDGET ====================
    function openMobileChat() {
      const overlay = document.getElementById('chat-overlay');
      const chatMobile = document.getElementById('chat-mobile');
      const notification = document.getElementById('chat-notification');
      
      if (overlay && chatMobile) {
        overlay.classList.add('active');
        chatMobile.classList.add('active');
        mobileChat.isOpen = true;
        
        if (notification) {
          notification.style.display = 'none';
        }
        
        document.body.style.overflow = 'hidden';
        
        const mobileInput = document.getElementById('mobile-user-input');
        if (mobileInput) {
          setTimeout(() => mobileInput.focus(), 300);
        }
        
        // Sincronizza messaggi da desktop a mobile
        if (!mobileChat.isInitialized) {
          syncDesktopToMobile();
          mobileChat.isInitialized = true;
        }
        
        console.log('‚úÖ Chat mobile aperta');
      }
    }

    function closeMobileChat() {
      const overlay = document.getElementById('chat-overlay');
      const chatMobile = document.getElementById('chat-mobile');
      
      if (overlay && chatMobile) {
        overlay.classList.remove('active');
        chatMobile.classList.remove('active');
        mobileChat.isOpen = false;
        document.body.style.overflow = '';
        console.log('‚úÖ Chat mobile chiusa');
      }
    }

    function handleMobileEnterKey(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMobileMessage();
      }
    }

    // ==================== UNIFIED MESSAGE SYSTEM ====================
    async function sendMobileMessage() {
      const mobileInput = document.getElementById('mobile-user-input');
      const message = mobileInput.value.trim();
      
      if (!message) return;
      
      mobileInput.value = '';
      
      // Disabilita sync temporaneamente per evitare duplicati
      chatSyncEnabled = false;
      
      // Usa la stessa funzione del desktop attraverso chat.js
      if (typeof window.sendMessage === 'function') {
        // Imposta il messaggio nell'input desktop
        const desktopInput = document.getElementById('user-input');
        if (desktopInput) {
          desktopInput.value = message;
          
          // Chiama la funzione unificata di chat.js
          await window.sendMessage();
          
          // Pulisci l'input desktop
          desktopInput.value = '';
        }
      } else {
        // Fallback se chat.js non √® ancora caricato
        await waitForChatJSAndSend(message);
      }
      
      // Riabilita sync
      setTimeout(() => {
        chatSyncEnabled = true;
      }, 100);
    }

    async function waitForChatJSAndSend(message) {
      let attempts = 0;
      const maxAttempts = 20;
      
      const waitInterval = setInterval(async () => {
        attempts++;
        
        if (typeof window.sendMessage === 'function') {
          clearInterval(waitInterval);
          
          const desktopInput = document.getElementById('user-input');
          if (desktopInput) {
            desktopInput.value = message;
            await window.sendMessage();
            desktopInput.value = '';
          }
        } else if (attempts >= maxAttempts) {
          clearInterval(waitInterval);
          
          // Messaggio di errore unificato
          await appendUnifiedMessage('bot', '‚ö†Ô∏è Servizio temporaneamente non disponibile. Riprova pi√π tardi.');
        }
      }, 250);
    }

    // ==================== UNIFIED MESSAGE APPEND ====================
    async function appendUnifiedMessage(type, message) {
      if (!chatSyncEnabled) return;
      
      // Aggiungi al desktop
      const desktopChatBody = document.getElementById('chat-body');
      if (desktopChatBody) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = message;
        
        desktopChatBody.appendChild(messageDiv);
        desktopChatBody.scrollTop = desktopChatBody.scrollHeight;
      }
      
      // Aggiungi al mobile se √® aperto
      if (mobileChat.isOpen) {
        const mobileChatBody = document.getElementById('chat-mobile-body');
        if (mobileChatBody) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${type}`;
          messageDiv.innerHTML = message;
          
          mobileChatBody.appendChild(messageDiv);
          mobileChatBody.scrollTop = mobileChatBody.scrollHeight;
        }
      }
      
      console.log(`üí¨ Messaggio ${type} aggiunto (Sistema Unificato)`);
    }

    // ==================== DESKTOP TO MOBILE SYNC ====================
    function syncDesktopToMobile() {
      const desktopChatBody = document.getElementById('chat-body');
      const mobileChatBody = document.getElementById('chat-mobile-body');
      
      if (!desktopChatBody || !mobileChatBody) return;
      
      // Pulisci chat mobile
      mobileChatBody.innerHTML = '';
      
      // Copia tutti i messaggi dal desktop al mobile
      const desktopMessages = desktopChatBody.querySelectorAll('.message');
      
      desktopMessages.forEach(msg => {
        const clonedMsg = msg.cloneNode(true);
        mobileChatBody.appendChild(clonedMsg);
      });
      
      // Scroll in fondo
      mobileChatBody.scrollTop = mobileChatBody.scrollHeight;
      
      // Riattiva event listeners per pulsanti clonati
      setTimeout(() => {
        setupClonedButtonListeners(mobileChatBody);
      }, 100);
      
      console.log('‚úÖ Chat desktop sincronizzata con mobile');
    }

    // ==================== MOBILE TO DESKTOP SYNC ====================
    function syncMobileToDesktop() {
      const desktopChatBody = document.getElementById('chat-body');
      const mobileChatBody = document.getElementById('chat-mobile-body');
      
      if (!desktopChatBody || !mobileChatBody || !mobileChat.isOpen) return;
      
      // Conta messaggi attuali
      const desktopMsgCount = desktopChatBody.children.length;
      const mobileMsgCount = mobileChatBody.children.length;
      
      // Se mobile ha pi√π messaggi, sincronizza
      if (mobileMsgCount > desktopMsgCount) {
        const newMessages = Array.from(mobileChatBody.children).slice(desktopMsgCount);
        
        newMessages.forEach(msg => {
          const clonedMsg = msg.cloneNode(true);
          desktopChatBody.appendChild(clonedMsg);
        });
        
        desktopChatBody.scrollTop = desktopChatBody.scrollHeight;
        console.log('‚úÖ Chat mobile sincronizzata con desktop');
      }
    }

    // ==================== BUTTON LISTENERS SETUP ====================
    function setupClonedButtonListeners(container) {
      // Setup pulsanti opzione
      const optionButtons = container.querySelectorAll('.chat-option-btn[data-action]');
      optionButtons.forEach(btn => {
        if (!btn.hasAttribute('data-mobile-listener')) {
          btn.setAttribute('data-mobile-listener', 'true');
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.getAttribute('data-action');
            if (action && typeof window.handleQuickOption === 'function') {
              window.handleQuickOption(action);
            }
          });
        }
      });
      
      // Setup pulsanti GDPR
      const gdprButtons = container.querySelectorAll('#gdpr-accept-btn');
      gdprButtons.forEach(btn => {
        if (!btn.hasAttribute('data-mobile-listener')) {
          btn.setAttribute('data-mobile-listener', 'true');
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof window.acceptGDPR === 'function') {
              window.acceptGDPR();
            }
          });
        }
      });
    }

    // ==================== CHAT INITIALIZATION OVERRIDE ====================
    // Override della funzione appendMessage di chat.js per sincronizzazione
    function interceptChatJSAppendMessage() {
      // Attendi che chat.js sia caricato
      const checkInterval = setInterval(() => {
        if (window.appendMessage && typeof window.appendMessage === 'function') {
          clearInterval(checkInterval);
          
          // Salva la funzione originale
          const originalAppendMessage = window.appendMessage;
          
          // Override con sincronizzazione
          window.appendMessage = async function(type, message) {
            // Chiama la funzione originale
            await originalAppendMessage(type, message);
            
            // Sincronizza con mobile se √® aperto
            if (mobileChat.isOpen && chatSyncEnabled) {
              const mobileChatBody = document.getElementById('chat-mobile-body');
              if (mobileChatBody) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = message;
                
                mobileChatBody.appendChild(messageDiv);
                mobileChatBody.scrollTop = mobileChatBody.scrollHeight;
                
                // Setup listeners per eventuali pulsanti
                setTimeout(() => {
                  setupClonedButtonListeners(mobileChatBody);
                }, 100);
              }
            }
          };
          
          console.log('‚úÖ Intercettazione appendMessage attivata');
        }
      }, 100);
    }

    // ==================== RESPONSIVE CHAT DETECTION ====================
    function detectMobileChat() {
      const isMobile = window.innerWidth <= 768;
      const desktopChat = document.querySelector('.chat-window');
      const mobileWidget = document.querySelector('.chat-widget');
      
      if (isMobile) {
        if (desktopChat) desktopChat.style.display = 'none';
        if (mobileWidget) mobileWidget.style.display = 'block';
      } else {
        if (desktopChat) desktopChat.style.display = 'flex';
        if (mobileWidget) mobileWidget.style.display = 'none';
        closeMobileChat();
      }
    }

    // ==================== POPUP MANAGEMENT ====================
    function openPopup(popupId) {
      const overlay = document.getElementById('overlay-bg');
      const popup = document.getElementById(popupId);
      
      if (overlay && popup) {
        overlay.style.display = 'block';
        popup.style.display = 'block';
        popup.focus();
        document.body.style.overflow = 'hidden';
        console.log(`‚úÖ Popup ${popupId} aperto`);
      }
    }

    function closePopup(popupId) {
      const overlay = document.getElementById('overlay-bg');
      const popup = document.getElementById(popupId);
      
      if (overlay && popup) {
        overlay.style.display = 'none';
        popup.style.display = 'none';
        document.body.style.overflow = '';
        console.log(`‚úÖ Popup ${popupId} chiuso`);
      }
    }

    function closeAllPopups() {
      document.querySelectorAll('.info-popup').forEach(popup => {
        popup.style.display = 'none';
      });
      
      const overlay = document.getElementById('overlay-bg');
      if (overlay) {
        overlay.style.display = 'none';
      }
      
      document.body.style.overflow = '';
      console.log('‚úÖ Tutti i popup chiusi');
    }

    // ==================== GALLERY MANAGEMENT ====================
    function updateMainGallery(imgElement) {
      const mainImg = document.getElementById('main-gallery-img');
      if (mainImg && imgElement) {
        mainImg.src = imgElement.src;
        mainImg.alt = imgElement.alt;
        mainImg.focus();
        console.log('‚úÖ Immagine gallery aggiornata');
      }
    }

    function handleImageKeyPress(event, imgElement) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        updateMainGallery(imgElement);
      }
    }

    // ==================== CHAT MANAGEMENT ====================
    function handleEnterKey(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        // Usa la funzione unificata da chat.js
        if (typeof window.sendMessage === 'function') {
          window.sendMessage();
        }
      }
    }

    function sendMessage() {
      // Questa funzione viene sovrascritta da chat.js
      console.log('üìß Invio messaggio desktop - delegando a chat.js...');
    }

    function showMobileNotification() {
      const notification = document.getElementById('chat-notification');
      if (notification && !mobileChat.isOpen && window.innerWidth <= 768) {
        notification.style.display = 'flex';
        mobileChat.hasNewMessage = true;
      }
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM caricato, inizializzazione sistema unificato...');
      
      detectMobileChat();
      
      // Intercetta appendMessage di chat.js per sincronizzazione
      interceptChatJSAppendMessage();
      
      const overlay = document.getElementById('overlay-bg');
      if (overlay) {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAllPopups();
          }
        });
      }
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllPopups();
          if (mobileChat.isOpen) {
            closeMobileChat();
          }
        }
      });

      document.querySelectorAll('.info-popup').forEach(popup => {
        popup.setAttribute('tabindex', '-1');
      });

      const chatInput = document.getElementById('user-input');
      if (chatInput && window.innerWidth > 768) {
        setTimeout(() => chatInput.focus(), 500);
      }

      if (window.innerWidth <= 768) {
        setTimeout(showMobileNotification, 3000);
      }

      console.log('‚úÖ Sistema unificato inizializzato');
    });

    window.addEventListener('resize', function() {
      detectMobileChat();
      if (window.innerWidth > 768 && mobileChat.isOpen) {
        closeMobileChat();
      }
    });
    
    window.addEventListener('orientationchange', function() {
      setTimeout(detectMobileChat, 100);
    });

    window.addEventListener('error', function(e) {
      console.error('‚ùå Errore JavaScript:', e.error);
      
      // Mostra errore su entrambe le chat
      if (mobileChat.isOpen) {
        appendUnifiedMessage('bot', '‚ö†Ô∏è Si √® verificato un errore. Riprova pi√π tardi.');
      }
    });

    window.addEventListener('load', function() {
      console.log('‚ö° Pagina completamente caricata');
      if (window.performance && window.performance.timing) {
        const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
        console.log(`üìä Tempo di caricamento: ${loadTime}ms`);
      }
    });

    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && window.innerWidth <= 768 && !mobileChat.isOpen) {
        showMobileNotification();
      }
    });

    // ==================== GLOBAL FUNCTIONS ====================
    window.mobileChat = mobileChat;
    window.openMobileChat = openMobileChat;
    window.closeMobileChat = closeMobileChat;
    window.appendUnifiedMessage = appendUnifiedMessage;
    window.syncDesktopToMobile = syncDesktopToMobile;
    window.syncMobileToDesktop = syncMobileToDesktop;
  </script>
  
  <!-- ==================== EXTERNAL SCRIPTS ==================== -->
  <script src="functions.js"></script>
  <script src="ui-manager.js"></script>
  <script src="chat.js"></script>

  <!-- ==================== SCHEMA.ORG MARKUP ==================== -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "DentalClinic",
    "name": "Studio Dentistico Demo",
    "description": "Studio dentistico con assistente digitale per informazioni e prenotazioni",
    "url": "https://www.studiodemo.it",
    "telephone": "+39-123-456-7890",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "Via Demo 123",
      "addressLocality": "Milano",
      "addressRegion": "MI",
      "postalCode": "20100",
      "addressCountry": "IT"
    },
    "openingHours": [
      "Mo-Fr 09:00-18:00",
      "Sa 09:00-13:00"
    ],
    "priceRange": "‚Ç¨‚Ç¨",
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Servizi Odontoiatrici",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Igiene Orale",
            "description": "Pulizia dentale professionale"
          }
        }
      ]
    }
  }
  </script>

  <!-- ==================== CSS TYPING ANIMATION ==================== -->
  <style>
    .chat-option-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 119, 204, 0.2);
    }
    
    .chat-option-btn:hover {
      background: linear-gradient(135deg, var(--primary-dark), #003d7a);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 119, 204, 0.3);
    }
    
    .typing-indicator {
      opacity: 0.7;
    }
    
    .typing-animation {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 0;
    }
    
    .typing-animation span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--primary-color);
      animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-animation span:nth-child(1) { animation-delay: -0.32s; }
    .typing-animation span:nth-child(2) { animation-delay: -0.16s; }
    .typing-animation span:nth-child(3) { animation-delay: 0s; }
    
    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</body>
</html>